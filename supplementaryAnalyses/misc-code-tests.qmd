---
title: "Miscellaneous insights and code proofs"
author: Giacomo Antonello
format: 
  html:
    embed-resources: true
    toc: true
editor: visual
---

```{r setup, message=FALSE, warning=FALSE}
library(tidyverse)
library(biobakeryUtils)
library(parkinsonsMetagenomicData)
library(mia)

library(limma)
library(ggpubr)

knitr::opts_chunk$set(
  message = FALSE, 
  warning = FALSE
)
set.seed(1234)
theme_set(theme_bw())
```

# `limma` produces almost identical statistics as `lm` but it's more efficient

  - Dataset: WallenZD_2022
  - transformation: $arcsin(\sqrt{relative~abundance}$
  - limma used directly with lmFit, no voom transformation applied
  
```{r}
wallenZD_2022_raw.tse <- sampleMetadata %>% 
  filter(study_name == "WallenZD_2022") %>% 
  returnSamples(data_type = "relative_abundance")

wallenZD_2022.tse <- pMD_enhance(wallenZD_2022_raw.tse, data_type = "relative_abundance", addPhyloTree = TRUE)

table(wallenZD_2022.tse@colData$control)

wallenZD_2022.tse <- transformAssay(wallenZD_2022.tse, assay.type = "relabundance", method = "hellinger") %>% 
  tidySummarizedExperiment::mutate_samples(control = factor(control, levels = c("Study Control", "Case")))
assay(wallenZD_2022.tse, "asin_sqrt") <- sqrt(assay(wallenZD_2022.tse, "hellinger"))
```

## lm calculation

```{r}
moltenAssay.df <- meltSE(wallenZD_2022.tse, assay.type ="asin_sqrt", add.col = c("control", "age", "sex"))

t0_lm <- Sys.time()
lm_clean <- moltenAssay.df %>% 
  group_by(FeatureID) %>% 
  nest() %>%
  mutate(
    model = map(data, ~ lm(asin_sqrt ~ control + age + sex, data = .x)),
    tidied = map(model, broom::tidy),
    glanced = map(model, glance)
  ) %>%
  unnest(tidied) %>%
  select(FeatureID, term, estimate, std.error, statistic, p.value)
t1_lm <- Sys.time()

peakRam_lm <- peakRAM::peakRAM(moltenAssay.df %>% 
  group_by(FeatureID) %>% 
  nest() %>%
  mutate(
    model = map(data, ~ lm(asin_sqrt ~ control + age + sex, data = .x)),
    tidied = map(model, broom::tidy),
    glanced = map(model, glance)
  ) %>%
  unnest(tidied) %>%
  select(FeatureID, term, estimate, std.error, statistic, p.value))

lm_clean_just_pd <- lm_clean %>% 
  filter(term == "controlCase") %>% arrange(p.value)

lm_clean_just_pd
```

## `limma` calcuation

```{r}
modMtx <- model.matrix(~ age + sex + control, data = as.data.frame(colData(wallenZD_2022.tse)))
t0_limma <- Sys.time()
lmFit_results <- lmFit(assay(wallenZD_2022.tse, "asin_sqrt"), design = modMtx) %>% 
  eBayes() %>% 
  topTable(coef = "controlCase", n = Inf, sort.by = "P", confint = TRUE, adjust.method = "BH") %>% 
  mutate(SE = (CI.R - CI.L)/3.92, .after = logFC) %>% 
  rownames_to_column("FeatureID") %>% 
  as_tibble()

peakRam_limma <- peakRAM::peakRAM(lmFit(assay(wallenZD_2022.tse, "asin_sqrt"), design = modMtx) %>% 
  eBayes() %>% 
  topTable(coef = "controlCase", n = Inf, sort.by = "P", confint = TRUE, adjust.method = "BH") %>% 
  mutate(SE = (CI.R - CI.L)/3.92, .after = logFC) %>% 
  rownames_to_column("FeatureID") %>% 
  as_tibble())

t1_limma <- Sys.time()
lmFit_results
```

## Scatterplots

```{r}
data_together <- dplyr::full_join(lmFit_results, lm_clean_just_pd, by = "FeatureID")

beta_scatter <- ggplot(data_together, aes(x = estimate, y = logFC)) + 
  geom_point() + 
  geom_abline(intercept = 0, slope = 1, color = "red") + 
  labs(caption = sprintf("Sum(Abs. diff.): %s", format(sum(abs(data_together$estimate- data_together$logFC)), scientific = TRUE, digits = 3)))

SE_scatter <- ggplot(data_together, aes(x = std.error, y = SE)) + 
  geom_point() + 
  geom_abline(intercept = 0, slope = 1, color = "red") + 
  labs(caption = sprintf("Sum(Abs. diff.): %s", format(sum(abs(data_together$SE - data_together$std.error)), scientific = TRUE, digits = 3)))

P_scatter <- ggplot(data_together, aes(x = p.value, y = P.Value)) + 
  geom_point() + 
  geom_abline(intercept = 0, slope = 1, color = "red") + 
  labs(caption = sprintf("Sum(Abs. diff.): %s", format(sum(abs(data_together$p.value - data_together$P.Value)), scientific = TRUE, digits = 3)))

t_stat_scatter <- ggplot(data_together, aes(x = statistic, y = t)) + 
  geom_point() + 
  geom_abline(intercept = 0, slope = 1, color = "red") + 
  labs(caption = sprintf("Sum(Abs. diff.): %s", format(sum(abs(data_together$statistic - data_together$t)), scientific = TRUE, digits = 3)))

ggarrange(beta_scatter, SE_scatter, P_scatter, t_stat_scatter)
```

## Performance evaluation

```{r}
rbind(
  peakRam_lm[,-1],
  peakRam_limma[,-1],
  peakRam_lm[,-1]/peakRam_limma[,-1]) %>% 
  mutate(Implementation = c("lm", "limma", "lm/limma")) %>% 
  relocate(Implementation)
```